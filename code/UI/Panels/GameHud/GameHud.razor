@using System;
@using Sandbox;
@using Sandbox.UI;
@namespace Battlebugs
@inherits Panel
@attribute [StyleSheet]

<root>
	<div class="header">
		<div class="player">
			@if (GameManager.Instance.Boards.Count > 0)
			{
				var player = GameManager.Instance.Boards.ElementAt(0);
				<img src="ui/player-banner.png" />
				<div class="content">
					@if (player.Network.OwnerConnection is null)
					{
						<img src="ui/cpu.png" />
					}
					else
					{
						<img src=@($"avatar:{player.Network.OwnerConnection.SteamId}") />
					}
					<span class="name">@player.GameObject.Name</span>
					<span class="score">ðŸª™ @player.Coins</span>
				</div>
			}
		</div>
		<div class="middle">
			<div class="bar">
				@if (GameManager.Instance.Boards.Count > 0)
				{
					var fill = GameManager.Instance.Boards.ElementAt(0).GetScorePercent() * 100f;
					<div class="fill" style="width: @(fill)%" />
				}
			</div>
			<div class="banner">@GetHeader()</div>
		</div>
		<div class="player opponent">
			@if (GameManager.Instance.Boards.Count > 1)
			{
				var opponent = GameManager.Instance.Boards.ElementAt(1);
				if (opponent.IsValid())
				{
					<img src="ui/player-banner.png" />
					<div class="content">
						@if (opponent.Network.OwnerConnection is null)
						{
							<img src="ui/cpu.png" />
						}
						else
						{
							<img src=@($"avatar:{opponent.Network.OwnerConnection.SteamId}") />
						}
						<span class="name">@opponent.GameObject.Name</span>
						<span class="score">ðŸª™ @opponent.Coins</span>
					</div>
				}
			}
		</div>
	</div>
</root>

@code
{
	public static GameHud Instance { get; private set; }

	protected override void OnAfterTreeRender(bool firstTime)
	{
		base.OnAfterTreeRender(firstTime);

		if (firstTime)
		{
			Instance = this;
		}
	}

	string GetHeader()
	{
		if (GameManager.Instance.State == GameState.Placing)
		{
			return "Place your bugs!";
		}
		if (GameManager.Instance.CurrentPlayer == BoardManager.Local)
		{
			return "It's your turn!";
		}
		return "Your opponent is thinking...";
	}

	protected override int BuildHash() => System.HashCode.Combine(GameManager.Instance.State, GetHeader(), Math.Floor(Time.Now / 2f));
}